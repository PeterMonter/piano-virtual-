<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Piano Virtual</title>

<style>
html,body{
  margin:0;
  padding:0;
  height:100%;
  overflow:hidden;
  background:transparent;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif
}

.wrapper{
  width:100%;
  height:100%;
  display:flex;
  justify-content:center;
  overflow:hidden
}

.container{
  width:100%;
  padding:10px;
  box-sizing:border-box
}

.scale-wrapper{
  width:100%;
  display:flex;
  justify-content:center;
  overflow:hidden
}

.scale{
  transform-origin:top center
}

/* CONTROLES */
.controls{
  display:flex;
  gap:14px;
  margin-bottom:10px;
  justify-content:center;
  flex-wrap:wrap
}
.controls.hidden{display:none}

button{
  padding:12px 20px;
  font-size:16px;
  border-radius:10px;
  border:1px solid #444;
  background:#f3f3f3;
  cursor:pointer;
  color:#000
}

button.active-btn{
  background:#8fa8c6;
  border-color:#4a6fa1
}

button.muted{
  background:#d9534f;
  color:#fff
}

#enableSound{
  margin-bottom:10px;
  background:#4a6fa1;
  color:#fff;
  border-color:#3a5b8a
}

/* PIANO */
.piano{
  position:relative;
  width:1456px;
  height:200px
}

.white{
  position:absolute;
  width:52px;
  height:200px;
  background:#fff;
  border:1px solid #000;
  box-sizing:border-box;
  cursor:pointer
}

.black{
  position:absolute;
  width:32px;
  height:120px;
  background:#000;
  z-index:2;
  cursor:pointer
}

.white.active{background:#8fa8c6}

.black.active{
  background:#2c4f6b;
  border:2px solid #9fc3ff;
  box-shadow:0 0 10px rgba(120,170,255,.9)
}

/* ETIQUETAS */
.note-label{
  position:absolute;
  bottom:6px;
  width:100%;
  text-align:center;
  font-size:13px;
  display:none;
  pointer-events:none
}

.black .note-label{
  color:#fff;
  font-size:11px;
  line-height:1.1
}

.black .note-label span{display:block}

.show-en .label-en{display:block}
.show-lat .label-lat{display:block}

/* DO CENTRAL */
.central-do-row{
  width:1456px;
  height:26px;
  position:relative;
  margin:4px auto 0
}

.central-do{
  position:absolute;
  left:calc(14 * 52px);
  width:52px;
  text-align:center;
  font-size:14px;
  color:#444
}
</style>
</head>

<body>
<div class="wrapper">
<div class="container">
<div class="scale-wrapper">
<div class="scale" id="scale">

<button id="enableSound">Activar sonido (iOS)</button>

<div class="controls">
  <button id="playChord">Reproducir (␣)</button>
  <button id="reset">Reset (R)</button>
  <button id="mute">Mute (M)</button>
  <button id="showEN">Nomenclatura anglosajona (A)</button>
  <button id="showLAT">Nomenclatura latina (L)</button>
</div>

<div class="piano" id="piano"></div>

<div class="central-do-row">
  <div class="central-do">Do&nbsp;C</div>
</div>

</div>
</div>
</div>
</div>

<script>
/* ========= ESCALADO ========= */
function resizeUI(){
  const s=document.getElementById("scale");
  const w=document.querySelector(".scale-wrapper").clientWidth;
  s.style.transform=`scale(${Math.min(w/1456,1)})`;
}
window.addEventListener("resize",resizeUI);
resizeUI();

/* ========= AUDIO ========= */
let audioCtx=null;
let audioUnlocked=false;
let isMuted=false;

const enableSoundBtn=document.getElementById("enableSound");

enableSoundBtn.addEventListener("pointerdown",()=>{
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  audioCtx.resume().then(()=>{
    audioUnlocked=true;
    enableSoundBtn.style.display="none";
  });
});

const midiToFreq=m=>440*Math.pow(2,(m-69)/12);

function playElectricPiano(freq){
  if(!audioUnlocked || isMuted) return;

  const t=audioCtx.currentTime;
  const o1=audioCtx.createOscillator();
  const o2=audioCtx.createOscillator();
  const g=audioCtx.createGain();
  const f=audioCtx.createBiquadFilter();

  o1.type="sine";
  o2.type="triangle";
  o1.frequency.value=freq;
  o2.frequency.value=freq*2;

  f.type="lowpass";
  f.frequency.value=3000;

  g.gain.setValueAtTime(0.0001,t);
  g.gain.linearRampToValueAtTime(0.35,t+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001,t+1.5);

  o1.connect(f);
  o2.connect(f);
  f.connect(g);
  g.connect(audioCtx.destination);

  o1.start(t);
  o2.start(t);
  o1.stop(t+1.6);
  o2.stop(t+1.6);
}

/* ========= PIANO ========= */
const piano=document.getElementById("piano");
const activeKeys=new Set();

let midi=36, whiteIndex=0;

const whiteEN=["C","D","E","F","G","A","B"];
const whiteLAT=["Do","Re","Mi","Fa","Sol","La","Si"];
const blackEN=[["C♯","D♭"],["D♯","E♭"],null,["F♯","G♭"],["G♯","A♭"],["A♯","B♭"],null];
const blackLAT=[["Do♯","Re♭"],["Re♯","Mi♭"],null,["Fa♯","Sol♭"],["Sol♯","La♭"],["La♯","Si♭"],null];

while(midi<=83){
  for(let i=0;i<7 && midi<=83;i++){
    const w=document.createElement("div");
    w.className="white";
    w.style.left=whiteIndex*52+"px";
    w.dataset.freq=midiToFreq(midi);

    const en=document.createElement("div");
    en.className="note-label label-en";
    en.textContent=whiteEN[i];

    const lat=document.createElement("div");
    lat.className="note-label label-lat";
    lat.textContent=whiteLAT[i];

    w.append(en,lat);
    w.addEventListener("pointerdown",()=>toggleKey(w));
    piano.appendChild(w);

    if(blackEN[i]){
      const b=document.createElement("div");
      b.className="black";
      b.style.left=whiteIndex*52+36+"px";
      b.dataset.freq=midiToFreq(midi+1);

      const ben=document.createElement("div");
      ben.className="note-label label-en";
      ben.innerHTML=`<span>${blackEN[i][0]}</span><span>${blackEN[i][1]}</span>`;

      const blat=document.createElement("div");
      blat.className="note-label label-lat";
      blat.innerHTML=`<span>${blackLAT[i][0]}</span><span>${blackLAT[i][1]}</span>`;

      b.append(ben,blat);
      b.addEventListener("pointerdown",()=>toggleKey(b));
      piano.appendChild(b);
    }

    midi+=2;
    if(i===2||i===6) midi-=1;
    whiteIndex++;
  }
}

function toggleKey(k){
  k.classList.toggle("active");
  k.classList.contains("active") ? activeKeys.add(k) : activeKeys.delete(k);
  playElectricPiano(k.dataset.freq);
}

/* ========= CONTROLES ========= */
document.getElementById("playChord").onclick=()=>{
  activeKeys.forEach(k=>playElectricPiano(k.dataset.freq));
};

document.getElementById("reset").onclick=()=>{
  activeKeys.forEach(k=>k.classList.remove("active"));
  activeKeys.clear();
};

document.getElementById("mute").onclick=()=>{
  isMuted=!isMuted;
  document.getElementById("mute").classList.toggle("muted",isMuted);
};

document.getElementById("showEN").onclick=()=>{
  piano.classList.toggle("show-en");
  piano.classList.remove("show-lat");
};

document.getElementById("showLAT").onclick=()=>{
  piano.classList.toggle("show-lat");
  piano.classList.remove("show-en");
};

/* ========= TECLADO ========= */
window.addEventListener("keydown",e=>{
  if(e.key==="h"||e.key==="H") document.querySelector(".controls").classList.toggle("hidden");
  if(e.key==="a"||e.key==="A") document.getElementById("showEN").click();
  if(e.key==="l"||e.key==="L") document.getElementById("showLAT").click();
  if(e.key==="r"||e.key==="R") document.getElementById("reset").click();
  if(e.key==="m"||e.key==="M") document.getElementById("mute").click();
  if(e.key===" "){ e.preventDefault(); document.getElementById("playChord").click(); }
});
</script>
</body>
</html>
